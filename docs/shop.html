<!doctype html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LWG Partners Network — Shop</title>
  <meta name="description" content="Browse products from LWG Partners Network. Quality • Reliability • Impact."/>
  <meta name="theme-color" content="#002F5F"/>

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="LWG Partners Network — Shop">
  <meta property="og:description" content="Shop quality products with reliable delivery.">
  <meta property="og:image" content="images/logo/blue-logo-512.png">

  <!-- Icons + CSS -->
  <link rel="icon" href="images/logo/blue-logo-512.png"/>
  <link rel="stylesheet" href="css/styles.css"/>

  <!-- Core helpers (badge, mobile nav) -->
  <script defer src="js/app.js"></script>

  <!-- Page-only tweaks -->
  <style>
    /* Admin-only container is hidden unless body[data-admin="true"] */
    .admin-only { display: none; }
    body[data-admin="true"] .admin-only { display: block; }

    /* Tools / controls (admin) */
    .shop-tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .shop-tools .btn{padding:8px 12px;border-radius:10px;border:1px solid #d8e1ee;background:#f8fafc;cursor:pointer}
    .shop-tools .btn.primary{background:#002F5F;color:#fff;border-color:#002F5F}

    details.add-panel{background:#fff;border:1px solid #e3e8ef;border-radius:14px;padding:12px;margin:10px 0}
    details.add-panel summary{list-style:none;outline:0;cursor:pointer;font-weight:600}
    details.add-panel summary::-webkit-details-marker{display:none}

    .form-grid{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
    .form-grid .span-2{grid-column:1/-1}
    .form-grid label{display:flex;flex-direction:column;gap:6px}
    .form-grid input,.form-grid select,.form-grid textarea{
      padding:10px;border:1px solid #d8e1ee;border-radius:10px
    }
    .img-preview{display:inline-block;width:110px;height:110px;border:1px dashed #d8e1ee;border-radius:10px;background:#f8fafc;object-fit:cover}

    /* Product grid tidy-ups */
    .grid-products{margin-top:12px}
    .product-card{display:flex;flex-direction:column;gap:8px}

    /* Uniform image box (consistent size/height) */
    :root { --card-img-h: clamp(170px, 28vw, 240px); }
    .product-card .media{
      width:100%; height:var(--card-img-h);
      border-radius:10px; overflow:hidden; background:#f1f5f9;
      margin-bottom:8px; /* small consistent gap */
    }
    .product-card .media img{width:100%; height:100%; object-fit:cover; display:block}

    /* Tighten text spacing below image on mobile */
    .product-card h3{margin:0 0 4px}
    .product-desc{
      color:#475569;font-size:.92rem;margin:0 0 6px;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; min-height:2.6em
    }
    .product-actions{display:flex;gap:6px;margin-top:6px;align-items:center;flex-wrap:wrap}
    .product-actions .btn.small{padding:6px 8px;font-size:.9rem;border-radius:8px;border:1px solid #d8e1ee;background:#f8fafc}
    .product-actions .btn.primary.small{background:#002F5F;color:#fff;border-color:#002F5F}
    .product-actions .btn.danger{background:#fff1f2;border-color:#fecdd3}
    .qty-input{width:70px;text-align:center;padding:6px;border:1px solid #d8e1ee;border-radius:8px}

    .notice{border:1px dashed #eab308;background:#fffbea;color:#854d0e;padding:10px;border-radius:10px}
    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="wrap header-inner">
      <a class="brand" href="index.html">
        <img src="images/logo/blue-logo-banner.png" alt="LWG Partners Network"/>
        <div class="brand-text">
          <strong>LWG Partners Network</strong>
          <span class="tagline">Quality • Reliability • Impact</span>
        </div>
      </a>

      <!-- Mobile menu button (three spans required by CSS) -->
      <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false" aria-controls="siteNav">
        <span></span><span></span><span></span>
      </button>

      <!-- Main nav -->
      <nav class="nav" id="siteNav">
        <a href="index.html">Home</a>
        <a href="shop.html" aria-current="page">Shop</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
        <a href="cart.html" class="cart-link">Cart <span id="cartBadge" class="badge">0</span></a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="wrap">
    <section class="card">
      <div class="shop-header">
        <h1>Shop</h1>

        <div class="filters" role="search">
          <label class="visually-hidden" for="searchInput">Search products</label>
          <input id="searchInput" type="search" placeholder="Search products…" aria-label="Search products"/>

          <label class="visually-hidden" for="categoryFilter">Filter by category</label>
          <select id="categoryFilter" aria-label="Filter by category">
            <option value="">All Categories</option>
          </select>
        </div>
      </div>

      <!-- ===== ADMIN-ONLY: hidden for customers ===== -->
      <div class="admin-only">
        <div class="shop-tools">
          <button id="btnExport" class="btn">Export products (JSON)</button>
          <button id="btnImport" class="btn">Import products (JSON)</button>
          <button id="btnClear" class="btn">Clear all products</button>
        </div>

        <details class="add-panel">
          <summary>➕ Add a Product</summary>
          <div style="margin-top:10px">
            <div class="form-grid">
              <label>Product ID
                <input id="pId" placeholder="sku-001"/>
              </label>
              <label>Title
                <input id="pTitle" placeholder="Product title"/>
              </label>
              <label>Price (NLe)
                <input id="pPrice" type="number" min="0" step="1" placeholder="250"/>
              </label>
              <label>Category
                <input id="pCategory" placeholder="Men / Women / Kids / Essentials"/>
              </label>

              <!-- Image: URL path or pick a file (stored as base64 data URL) -->
              <label>Image URL / Path
                <input id="pImage" placeholder="images/products/polo1.jpg"/>
              </label>
              <label>Or choose image file
                <input id="pImageFile" type="file" accept="image/*"/>
              </label>
              <div class="span-2">
                <img id="pPreview" class="img-preview" alt="preview"/>
              </div>

              <label class="span-2">Writings / Description
                <textarea id="pDesc" rows="3" placeholder="Short description for this product"></textarea>
              </label>
              <label>Stock
                <input id="pStock" type="number" min="0" step="1" placeholder="50"/>
              </label>
              <div class="span-2" style="display:flex; gap:8px; flex-wrap:wrap">
                <button id="btnAdd" class="btn primary">Add Product</button>
                <button id="btnReset" class="btn">Reset</button>
              </div>
            </div>
            <p class="notice" style="margin-top:10px">
              Admin tip: open <b>shop.html#admin</b> (or <b>?admin=1</b>) to show this panel on any device.
              After editing, use <b>Export</b> and upload to <code>docs/data/products.json</code> so all devices match.
            </p>
          </div>
        </details>
      </div>
      <!-- ===== /ADMIN-ONLY ===== -->

      <!-- Products grid -->
      <div id="productGrid" class="grid-products" aria-live="polite"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="wrap foot">
      <p>© <span id="year"></span> LWG Partners Network — Creating Impact Globally</p>
      <div class="socials">
        <a href="https://wa.me/23272146015" target="_blank" rel="noopener">WhatsApp</a>
        <a href="mailto:info@lwgpartnersnetwork.com">Email</a>
        <a href="https://lwgpartnersnetwork.com" target="_blank" rel="noopener">Website</a>
      </div>
    </div>
  </footer>

  <!-- A11y helper -->
  <style>.visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}</style>

  <!-- Inline script: shared catalog (data/products.json) + local admin + uniform cards -->
  <script>
    (function(){
      const KEY = 'lwg_products';     // local product store
      const ADMIN_KEY = 'lwg_admin';  // "1" => admin mode on
      const CART_KEY = 'lwg_cart';
      const REMOTE_URL = 'data/products.json'; // shared catalog file in /docs/data/

      const $ = (s, el=document)=>el.querySelector(s);
      const grid = $('#productGrid');
      const search = $('#searchInput');
      const catSel = $('#categoryFilter');
      const previewEl = $('#pPreview');
      const fileInputEl = $('#pImageFile');
      const pImageInputEl = $('#pImage');

      // helpers
      const escapeHtml = (s='') => String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      const escapeAttr = (s='') => escapeHtml(s).replaceAll('"','&quot;');
      const num = v => Number(String(v).replace(/[^\d.-]/g, '')) || 0;
      const money = (n)=> new Intl.NumberFormat('en-SL',{maximumFractionDigits:0}).format(num(n));

      /* -------- Admin toggle: URL hash/query + keyboard + mobile gestures -------- */
      function setAdmin(on){
        document.body.setAttribute('data-admin', on ? 'true' : 'false');
        localStorage.setItem(ADMIN_KEY, on ? '1' : '0');
      }
      function adminRequested(){
        const h = (location.hash||'').toLowerCase();
        const q = (location.search||'').toLowerCase();
        return h.includes('admin') || q.includes('admin=1');
      }
      setAdmin(localStorage.getItem(ADMIN_KEY) === '1' || adminRequested());
      addEventListener('hashchange', ()=>{ if (adminRequested()) setAdmin(true); });

      // Desktop key: Alt+Shift+A
      addEventListener('keydown', (e)=>{
        if (e.altKey && e.shiftKey && (e.key.toLowerCase() === 'a')) {
          e.preventDefault();
          setAdmin(document.body.getAttribute('data-admin') !== 'true');
        }
      });
      // Mobile: long press (700ms) or 5 taps on the brand
      const brand = document.querySelector('.brand');
      if (brand){
        let holdTimer=null;
        brand.addEventListener('touchstart', ()=>{ holdTimer=setTimeout(()=> setAdmin(document.body.getAttribute('data-admin')!=='true'),700); });
        ['touchend','touchcancel','touchmove'].forEach(ev=> brand.addEventListener(ev, ()=> clearTimeout(holdTimer)));
        let taps=0, tm=null;
        brand.addEventListener('click', ()=>{
          taps++;
          if(!tm){ tm=setTimeout(()=>{ if(taps>=5) setAdmin(document.body.getAttribute('data-admin')!=='true'); taps=0; tm=null; },500); }
        });
      }

      /* -------- Products storage (local) -------- */
      const readProducts = ()=>{ try { return JSON.parse(localStorage.getItem(KEY)) || []; } catch { return []; } };
      const writeProducts = (arr)=>{ localStorage.setItem(KEY, JSON.stringify(arr||[])); buildCategories(arr||[]); render(); };

      /* -------- Fetch shared catalog & unify with local -------- */
      async function fetchRemote(){
        try{
          const res = await fetch(REMOTE_URL + '?v=' + Date.now(), {cache:'no-store'});
          if(!res.ok) throw 0;
          const json = await res.json();
          return Array.isArray(json) ? json : [];
        }catch{ return []; }
      }
      async function loadUnified(){
        const [remote, local] = await Promise.all([fetchRemote(), readProducts()]);
        // unify by id: local overrides remote
        const map = new Map();
        (remote||[]).forEach(p=> map.set(String(p.id), p));
        (local||[]).forEach(p=> map.set(String(p.id), p));
        const unified = [...map.values()];
        writeProducts(unified);
      }

      /* -------- Categories -------- */
      function buildCategories(items){
        if (!catSel) return;
        const keep = catSel.value || '';
        const cats = Array.from(new Set(items.map(p=>p.category).filter(Boolean))).sort();
        catSel.innerHTML = '<option value="">All Categories</option>' + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        if (cats.includes(keep)) catSel.value = keep;
      }

      /* -------- Render grid (uniform image box) -------- */
      function render(){
        const items = readProducts();
        const term = (search?.value||'').toLowerCase();
        const cat  = catSel?.value || '';
        const admin = document.body.getAttribute('data-admin') === 'true';

        const list = (items||[]).filter(p=>{
          const okTerm = !term || (String(p.title||'').toLowerCase().includes(term) || String(p.description||'').toLowerCase().includes(term));
          const okCat  = !cat  || String(p.category||'') === cat;
          return okTerm && okCat;
        });

        if (!list.length){
          grid.innerHTML = '<div class="card" style="border-color:#eab308">No products yet. Add some (admin only).</div>';
          return;
        }

        grid.innerHTML = list.map(p=>`
          <article class="product-card" data-id="${escapeAttr(p.id)}">
            <div class="media">
              <img src="${escapeAttr(p.image||'')}" alt="${escapeAttr(p.title||'')}"
                   onerror="this.src='images/logo/blue-logo-512.png'"/>
            </div>
            <h3>${escapeHtml(p.title||'')}</h3>
            <div class="muted">${escapeHtml(p.category||'')}</div>
            ${p.description ? `<p class="product-desc">${escapeHtml(p.description)}</p>` : ''}
            <div class="price">NLe ${money(p.price)}</div>
            <div class="product-actions">
              <button class="btn small" data-action="minus">−</button>
              <input class="qty-input" type="number" value="1" min="1" max="${Number(p.stock||0)}"/>
              <button class="btn small" data-action="plus">+</button>
              <button class="btn primary small" data-action="add">Add to Cart</button>
              ${admin ? '<button class="btn small danger" data-action="del" title="Remove product">Delete</button>' : ''}
            </div>
          </article>
        `).join('');
      }

      /* -------- Cart badge -------- */
      const readCart = () => { try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; } };
      const writeCart = (items) => { localStorage.setItem(CART_KEY, JSON.stringify(items||[])); updateBadge(); };
      function updateBadge(){
        const cart = readCart();
        const count = cart.reduce((a,it)=>a + (num(it.qty)||0), 0);
        const bd = document.getElementById('cartBadge');
        if (bd) bd.textContent = String(count);
      }

      /* -------- Search / Category -------- */
      search?.addEventListener('input', render);
      catSel?.addEventListener('change', render);

      /* -------- Grid actions -------- */
      grid.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if (!btn) return;
        const card = btn.closest('.product-card'); if (!card) return;
        const id = card.dataset.id;
        const items = readProducts();
        const product = items.find(p=>String(p.id)===String(id));
        const qtyInput = card.querySelector('.qty-input');

        if (btn.dataset.action === 'minus') qtyInput.value = Math.max(1, parseInt(qtyInput.value||'1') - 1);
        if (btn.dataset.action === 'plus')  qtyInput.value = Math.min(Number(product?.stock||9999), parseInt(qtyInput.value||'1') + 1);
        if (btn.dataset.action === 'add'){
          const qty = Math.max(1, Math.min(Number(product?.stock||9999), parseInt(qtyInput.value||'1')));
          const cart = readCart();
          const ex = cart.find(it=>String(it.id)===String(id));
          if (ex) ex.qty = (num(ex.qty) + qty); else cart.push({ id, qty, title:product.title, price:product.price, image:product.image });
          writeCart(cart);
          btn.textContent = 'Added ✓'; setTimeout(()=> btn.textContent='Add to Cart', 900);
        }
        if (btn.dataset.action === 'del'){
          writeProducts(items.filter(p=>String(p.id)!==String(id)));
        }
      });

      /* -------- ADMIN: add/reset/export/import/clear -------- */
      const btnAdd   = document.getElementById('btnAdd');
      const btnReset = document.getElementById('btnReset');
      const btnExport= document.getElementById('btnExport');
      const btnImport= document.getElementById('btnImport');
      const btnClear = document.getElementById('btnClear');

      // Image file -> base64 preview (works on phone camera/gallery)
      if (fileInputEl){
        fileInputEl.addEventListener('change', ()=>{
          const f = fileInputEl.files?.[0]; if (!f) return;
          const r = new FileReader();
          r.onload = () => { pImageInputEl.value = String(r.result||''); if (previewEl) previewEl.src = pImageInputEl.value; };
          r.readAsDataURL(f);
        });
      }
      pImageInputEl?.addEventListener('input', ()=>{ if (previewEl) previewEl.src = pImageInputEl.value; });

      if (btnAdd) btnAdd.addEventListener('click', ()=>{
        const p = {
          id: document.getElementById('pId').value.trim() || ('sku-' + Math.floor(100+Math.random()*900)),
          title: document.getElementById('pTitle').value.trim(),
          price: num(document.getElementById('pPrice').value),
          category: document.getElementById('pCategory').value.trim(),
          image: document.getElementById('pImage').value.trim(),
          description: document.getElementById('pDesc').value.trim(),
          stock: num(document.getElementById('pStock').value)
        };
        const items = readProducts();
        if (!p.title){ alert('Title is required.'); return; }
        if (items.some(x=>String(x.id)===String(p.id))){
          alert('A product with this ID already exists. Use a unique ID.');
          return;
        }
        items.push(p);
        writeProducts(items);

        ['pTitle','pPrice','pCategory','pImage','pDesc','pStock','pId'].forEach(id=>{ const el = document.getElementById(id); if(el) el.value=''; });
        if (fileInputEl) fileInputEl.value = '';
        if (previewEl) previewEl.removeAttribute('src');
      });

      btnReset?.addEventListener('click', ()=>{
        ['pId','pTitle','pPrice','pCategory','pImage','pDesc','pStock'].forEach(id=>{ const el = document.getElementById(id); if(el) el.value=''; });
        if (fileInputEl) fileInputEl.value = '';
        if (previewEl) previewEl.removeAttribute('src');
      });

      btnExport?.addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify(readProducts(), null, 2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'products.json'; a.click(); URL.revokeObjectURL(a.href);
      });

      btnImport?.addEventListener('click', ()=>{
        const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'application/json,.json';
        inp.addEventListener('change', async ()=>{
          const f = inp.files?.[0]; if(!f) return;
          try {
            const text = await f.text(); const arr = JSON.parse(text);
            if (!Array.isArray(arr)) throw new Error('JSON must be an array');
            writeProducts(arr);
          } catch { alert('Invalid JSON file.'); }
        });
        inp.click();
      });

      btnClear?.addEventListener('click', ()=>{ if (confirm('Clear ALL products?')) writeProducts([]); });

      // Boot: render whatever is local, then unify with shared file
      buildCategories(readProducts());
      render();
      loadUnified(); // pulls /data/products.json and merges so all devices match

      // initial badge sync
      (function initBadge(){
        const cart = readCart();
        const count = cart.reduce((a,it)=>a + (num(it.qty)||0), 0);
        const bd = document.getElementById('cartBadge');
        if (bd) bd.textContent = String(count);
      })();
    })();
  </script>
</body>
</html>
