<!doctype html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LWG Partners Network — Cart</title>
  <meta name="description" content="Your cart on LWG Partners Network"/>
  <meta name="theme-color" content="#002F5F"/>

  <!-- Social preview -->
  <meta property="og:title" content="Your Cart — LWG Partners Network">
  <meta property="og:description" content="Review your items and checkout via WhatsApp.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="images/logo/blue-logo-512.png">

  <!-- Icons -->
  <link rel="icon" href="images/logo/blue-favicon-64.png" sizes="64x64">
  <link rel="icon" href="images/logo/blue-favicon-32.png" sizes="32x32">
  <link rel="apple-touch-icon" href="images/logo/blue-logo-180.png">

  <!-- CSS -->
  <link rel="stylesheet" href="css/styles.css"/>

  <!-- Header utilities -->
  <script defer src="js/app.js?v=2025-09-07-1"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="wrap header-inner">
      <a class="brand" href="index.html">
        <img src="images/logo/blue-logo-banner.png" alt="LWG Partners Network"/>
        <div class="brand-text">
          <strong>LWG Partners Network</strong>
          <span class="tagline">Quality • Reliability • Impact</span>
        </div>
      </a>

      <!-- Mobile menu button -->
      <button class="nav-toggle" id="navToggle"
              aria-label="Toggle navigation" aria-expanded="false" aria-controls="siteNav">
        <span></span><span></span><span></span>
      </button>

      <!-- Main nav -->
      <nav class="nav" id="siteNav">
        <a href="index.html">Home</a>
        <a href="shop.html">Shop</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
        <a href="cart.html" class="cart-link" aria-current="page">
          Cart <span id="cartBadge" class="badge">0</span>
        </a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="wrap">
    <section class="card" aria-labelledby="cartTitle">
      <h1 id="cartTitle">Your Cart</h1>

      <!-- Line items -->
      <div id="cartItems" aria-live="polite"></div>

      <!-- Totals -->
      <div class="cart-totals" style="margin-top:10px">
        <div><strong>Subtotal: NLe <span id="cartSubtotal">0</span></strong></div>
        <div>Delivery: NLe <span id="deliveryFee">0</span></div>
        <div class="grand"><strong>Total: NLe <span id="cartTotal">0</span></strong></div>
      </div>

      <!-- Customer / Delivery / Payment -->
      <div class="form-grid" style="margin:14px 0;">
        <label>Name
          <input id="custName" autocomplete="name" placeholder="e.g., Mohamed K."/>
        </label>

        <label>Phone/WhatsApp
          <input id="custPhone" inputmode="tel" autocomplete="tel"
                 placeholder="+232 7X XXX XXX"/>
        </label>

        <label class="span-2">Delivery Address
          <input id="custAddress" autocomplete="street-address" placeholder="Street / area / city"/>
        </label>

        <!-- Delivery location selector (controls delivery fee) -->
        <label class="span-2">Delivery Location
          <select id="deliveryLocation">
            <option value="">Select location…</option>
            <!-- value format: slug|fee -->
            <option value="Freetown|20">Western — NLe 20</option>
            <option value="Waterloo|25">Eastern — NLe 25</option>
            <option value="Makeni|40">Makeni — NLe 40</option>
            <option value="Bo|45">Bo — NLe 45</option>
            <option value="Kenema|50">Kenema — NLe 50</option>
          </select>
        </label>

        <!-- Payment method -->
        <label class="span-2">Payment Method
          <select id="paymentMethod">
            <option value="">Select payment…</option>
            <option value="orange">Orange Money</option>
            <option value="africell">Africell Money</option>
            <option value="bank">Bank Transfer</option>
            <option value="cod">Cash on Delivery</option>
          </select>
        </label>

        <!-- Auto-filled payment info -->
        <div id="paymentInfo" class="span-2"
             style="display:none; padding:10px 12px; border:1px dashed rgba(0,47,95,.25);
                    border-radius:10px; background:#f8fafc; font-size:.95rem;"
             aria-live="polite"></div>
      </div>

      <!-- Actions -->
      <div class="cta">
        <a href="shop.html" class="btn ghost">Continue Shopping</a>
        <button id="checkoutBtn" class="btn primary">Checkout via WhatsApp</button>
        <!-- We'll add the "Send me a copy" button here dynamically -->
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="wrap foot">
      <p>© <span id="year"></span> LWG Partners Network — Creating Impact Globally</p>
      <div class="socials">
        <a href="https://wa.me/23272146015" target="_blank" rel="noopener">WhatsApp</a>
        <a href="mailto:info@lwgpartnersnetwork.com">Email</a>
        <a href="https://lwgpartnersnetwork.com" target="_blank" rel="noopener">Website</a>
      </div>
    </div>
  </footer>

  <!-- Robust cart logic -->
  <script>
    (function(){
      const CART_KEY = 'lwg_cart';
      const PROD_KEY = 'lwg_products';

      const $ = (s, el=document)=>el.querySelector(s);
      const listEl      = $('#cartItems');
      const subtotalEl  = $('#cartSubtotal');
      const deliveryEl  = $('#deliveryFee');
      const totalEl     = $('#cartTotal');
      const locationSel = $('#deliveryLocation');
      const paySel      = $('#paymentMethod');
      const payInfo     = $('#paymentInfo');
      const checkoutBtn = $('#checkoutBtn');

      // Helpers
      const num   = v => Number(String(v).replace(/[^\d.-]/g, '')) || 0; // handles "250,000", "NLe 250"
      const money = n => new Intl.NumberFormat('en-SL', { maximumFractionDigits: 0 }).format(num(n));

      const readCart      = () => { try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; } };
      const writeCart     = (items) => localStorage.setItem(CART_KEY, JSON.stringify(items));
      const readProducts  = () => { try { return JSON.parse(localStorage.getItem(PROD_KEY)) || []; } catch { return []; } };

      // Merge duplicate IDs just in case
      function normalizeCart(arr){
        const map = new Map();
        arr.forEach(it=>{
          const id = String(it.id);
          const qty = num(it.qty || 0);
          map.set(id, (map.get(id) || 0) + qty);
        });
        return Array.from(map, ([id, qty]) => ({ id, qty }));
      }

      function hydrate(cart){
        const normalized = normalizeCart(cart);
        const catalog = readProducts();
        const pm = new Map(catalog.map(p => [String(p.id), p]));
        return normalized.map(item=>{
          const p = pm.get(String(item.id)) || {};
          const price = num(p.price);
          const qty   = num(item.qty);
          const line  = price * qty;
          return { id: item.id, qty, price, line, title:p.title||'Product', image:p.image||'', category:p.category||'' };
        });
      }

      function render(){
        const rows = hydrate(readCart());

        if (!rows.length){
          listEl.innerHTML = '<div class="card" style="border-color:#eab308">Your cart is empty.</div>';
        } else {
          listEl.innerHTML = rows.map(it => `
            <div class="cart-row" data-id="${String(it.id)}" style="display:grid;grid-template-columns:80px 1fr auto auto auto;gap:10px;align-items:center;border-bottom:1px solid #e9eef5;padding:8px 0;">
              <img src="${it.image || 'images/logo/blue-logo-512.png'}" alt="${it.title}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;background:#f1f5f9"/>
              <div>
                <div class="title" style="font-weight:600">${it.title}</div>
                <div class="muted">${it.category}</div>
              </div>
              <div>Price: NLe ${money(it.price)}</div>
              <div class="qty" style="display:flex;gap:6px;align-items:center;">
                <button class="btn ghost" data-action="dec">−</button>
                <input class="qty-input" type="number" min="1" value="${it.qty}" style="width:70px;text-align:center"/>
                <button class="btn ghost" data-action="inc">+</button>
              </div>
              <div style="display:flex;gap:8px;align-items:center;">
                <div>Line: <b>NLe ${money(it.line)}</b></div>
                <button class="btn" title="Remove" data-action="remove">✕</button>
              </div>
            </div>`).join('');
        }

        // totals
        const subtotal = rows.reduce((a, r) => a + num(r.line), 0);
        const fee = (() => {
          const val = locationSel.value || '|0';
          const feeStr = val.split('|')[1] || '0';
          return num(feeStr);
        })();

        subtotalEl.textContent = money(subtotal);
        deliveryEl.textContent = money(fee);
        totalEl.textContent    = money(subtotal + fee);

        // badge
        const bd = document.getElementById('cartBadge');
        if (bd) bd.textContent = String(rows.reduce((a, r) => a + num(r.qty), 0));
      }

      // Qty & remove
      listEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if (!btn) return;
        const row = btn.closest('.cart-row'); if (!row) return;
        const id  = row.dataset.id;
        const cart = normalizeCart(readCart());
        const item = cart.find(it => String(it.id) === String(id));
        if (!item) return;

        if (btn.dataset.action === 'remove'){
          writeCart(cart.filter(it => String(it.id) !== String(id)));
          render();
        } else if (btn.dataset.action === 'inc' || btn.dataset.action === 'dec'){
          let q = num(item.qty);
          q += (btn.dataset.action === 'inc') ? 1 : -1;
          item.qty = Math.max(1, q);
          writeCart(cart);
          render();
        }
      });

      listEl.addEventListener('input', (e)=>{
        const input = e.target.closest('.qty-input'); if (!input) return;
        const row = input.closest('.cart-row'); const id = row.dataset.id;
        const cart = normalizeCart(readCart());
        const item = cart.find(it => String(it.id) === String(id));
        if (!item) return;
        item.qty = Math.max(1, num(input.value));
        writeCart(cart);
        render();
      });

      // Delivery fee & payment info
      locationSel.addEventListener('change', render);

      // Show real payment info (updated bank details)
      paySel.addEventListener('change', () => {
        const m = paySel.value;
        const map = {
          orange: 'Pay with <b>Orange Money</b>: Name: <b>LWG Partners Network</b> · Number: <code>+232 721 46015</code>.',
          africell: 'Pay with <b>Africell Money</b>: Name: <b>LWG Partners Network</b> · Number: <code>+232 30 774 701</code>.',
          bank: 'Bank Transfer:<br>Bank: <b>UBA</b><br>Account Name: <b>LWG Partners Network</b><br>Account No: <b>5409-1003-0001-447</b><br>Branch: <b>Freetown</b><br><i>Use your phone number as reference.</i>',
          cod: 'Cash on Delivery: Pay the rider on arrival.'
        };
        if (map[m]) { payInfo.style.display='block'; payInfo.innerHTML = map[m]; }
        else { payInfo.style.display='none'; payInfo.textContent=''; }
      });

      // Checkout (WhatsApp) — opens business chat, shows "Send me a copy", then clears cart
      checkoutBtn.addEventListener('click', () => {
        const name = document.getElementById('custName').value.trim();
        const phone = document.getElementById('custPhone').value.trim();
        const addr = document.getElementById('custAddress').value.trim();
        const [locSlug, feeStr] = (locationSel.value || '|0').split('|');
        const loc = (locSlug || '').trim();
        const fee = num(feeStr);
        const pay = (paySel.value || '').trim();

        const rows = hydrate(readCart());
        if (!rows.length) { alert('Your cart is empty.'); return; }
        if (!name || !phone || !addr || !loc || !pay) { alert('Please fill all delivery and payment fields.'); return; }

        const sub   = rows.reduce((a, r) => a + num(r.line), 0);
        const total = sub + fee;
        const lines = rows.map((x,i) => `• ${x.title} × ${x.qty} — NLe ${money(x.line)}`).join('\n');

        const msg = [
          'NEW ORDER',
          'Items:',
          lines,
          '',
          `Subtotal: NLe ${money(sub)}`,
          `Delivery (${loc}): NLe ${money(fee)}`,
          `Total: NLe ${money(total)}`,
          '',
          `Name: ${name}`,
          `Phone: ${phone}`,
          `Address: ${addr}`,
          `Payment: ${pay.toUpperCase()}`,
          '',
          `Source: ${location.href}`
        ].join('\n');

        // 1) Open business chat (you receive the order)
        const businessUrl = `https://wa.me/23272146015?text=${encodeURIComponent(msg)}`;
        window.open(businessUrl, '_blank', 'noopener');

        // 2) Add "Send me a copy" button for the customer
        const cta = document.querySelector('.cta');
        if (cta && !document.getElementById('copyToSelf')) {
          const digits = phone.replace(/\D/g,'');
          if (digits.length >= 8) {
            const copyA = document.createElement('a');
            copyA.id = 'copyToSelf';
            copyA.className = 'btn ghost';
            copyA.target = '_blank';
            copyA.rel = 'noopener';
            copyA.href = `https://wa.me/${digits}?text=${encodeURIComponent(msg)}`;
            copyA.textContent = 'Send me a copy';
            copyA.style.marginLeft = '8px';
            cta.appendChild(copyA);
          }
        }

        // 3) Clear the cart and refresh
        writeCart([]);
        render();
        setTimeout(() => location.reload(), 1200);
      });

      // Initial draw + initialize payment box state
      render();
      // trigger payment info refresh if a value is preselected
      paySel.dispatchEvent(new Event('change'));
    })();
  </script>
</body>
</html>
